{% extends "base_layout.html" %}
{% block title %}Manage Parking Spots{% endblock %}

{% block head_extra %}
{{ super() }}
<link rel="stylesheet" href="/static/CSS/parking_spot.css">
{% endblock %}

{% block content %}
{% include "admin_navbar.html" %}

<div class="main-content">
    <div class="container spot-container">
        <h3 class="text-center">View and Edit Parking Spots</h3>
        <p class="text-center mb-3">
            Parking Lot: <strong>{{ lot.primelocation_name }}</strong> (City: {{ lot.city }})
        </p>

        <div class="row">
            <!-- Left: Spots Grid -->
            <div class="col-md-7">
                <div class="spots-grid">
                    {% for spot in spots %}
                    <div class="spot {% if spot.status == 'O' %}occupied{% else %}available{% endif %}"
                         onclick="showDetails({{ spot.spot_id }}, '{{ spot.status }}')">
                        {{ spot.spot_id }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Right: Details Panel -->
            <div class="col-md-5">
                <div class="details-panel" id="details-panel">
                    <h5 class="text-center mb-3">Spot Details</h5>
                    <div id="details-content" class="text-center text-muted">
                        Click a parking spot to view details here.
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions mt-3">
            <p>✔ Click on an <strong style="color:red;">Occupied</strong> spot to view booking details.</p>
            <p>✔ Click on an <strong style="color:green;">Available</strong> spot to delete it.</p>
        </div>
    </div>
</div>

<script>
function showDetails(spotId, status) {
    const panel = document.getElementById("details-content");

    if (status === 'O') {
        fetch(`/admin/spot-details/${spotId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    panel.innerHTML = `<p class="text-danger">${data.error}</p>`;
                } else {
                    panel.innerHTML = `
                        <p><strong>User:</strong> ${data.user_name}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Vehicle No:</strong> ${data.vehicle_no}</p>
                        <p><strong>Start:</strong> ${data.parking_time}</p>
                        <p><strong>Expiry:</strong> ${data.leaving_time}</p>
                        <p><strong>Paid Cost:</strong> ₹${data.parking_cost}</p>
                        <button class="btn btn-secondary mt-2" onclick="clearDetails()">Close</button>
                    `;
                }
            });
    } else {
        panel.innerHTML = `
            <p><strong>Spot ID:</strong> ${spotId}</p>
            <p><strong>Status:</strong> Available</p>
            <button class="btn btn-danger mt-2" onclick="deleteSpot(${spotId})">Delete Spot</button>
            <button class="btn btn-secondary mt-2" onclick="clearDetails()">Close</button>
        `;
    }
}

function clearDetails() {
    document.getElementById("details-content").innerHTML = "Click a parking spot to view details here.";
}

function deleteSpot(spotId) {
    if (confirm('Are you sure you want to delete this spot?')) {
        fetch(`/admin/delete_spot/${spotId}`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    alert('Spot deleted successfully!');
                    location.reload();
                } else {
                    alert('Failed to delete spot.');
                }
            });
    }
}
</script>
{% endblock %}
